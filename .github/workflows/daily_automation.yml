name: AlgoPulse - Daily Dispatch

on:
  schedule:
    - cron: '30 1 * * *'  # 7:00 AM IST
    - cron: '30 14 * * *' # 8:00 PM IST
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  run-logic:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: pip install requests firebase-admin
      - name: Dispatch
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        run: |
          HOUR=$(date +%H)
          if [ "$HOUR" -lt "12" ]; then MODE="morning"; else MODE="solution"; fi
          python daily_question.py --mode $MODE

  deploy-interface:
    runs-on: ubuntu-latest
    needs: run-logic
    steps:
      - uses: actions/checkout@v4
      - name: Inject Configuration
        env:
          FIREBASE_CONFIG: ${{ secrets.FIREBASE_CONFIG }}
        run: |
          # This replaces the placeholder with the actual JSON string from your secrets
          # It only happens in the temporary action runner, not in your Git history!
          python -c "
          import os
          f = open('index.html', 'r')
          content = f.read()
          f.close()
          
          config = os.environ.get('FIREBASE_CONFIG', '{}')
          placeholder = 'configPlaceholder = \`GITHUB_FIREBASE_CONFIG_PLACEHOLDER\`'
          replacement = f'configPlaceholder = \`{config}\`'
          
          if 'GITHUB_FIREBASE_CONFIG_PLACEHOLDER' in content:
              new_content = content.replace(placeholder, replacement)
              with open('index.html', 'w') as f:
                  f.write(new_content)
              print('✅ Configuration injected.')
          else:
              print('⚠️ Placeholder not found.')
          "
      - uses: actions/upload-pages-artifact@v3
        with:
          path: '.'
      - uses: actions/deploy-pages@v4
